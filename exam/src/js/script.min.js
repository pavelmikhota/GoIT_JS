/* ---------------------------JQUERY--------------------------- */
//= partials/_jquery.js
/* ---------------------------JCAROUSEL--------------------------- */
;
//= partials/_jquery.jcarousel.js
;
//= partials/_jcarousel.js
;
/* ---------------------------Masonry--------------------------- */
//= partials/_masonry.pkgd.js
;
/* ---------------------------Template--------------------------- */
//= partials/_microTemplates.js
;
$(function () {
  var isActive = false;
  var getData = function (q) { // Запрос данных и отправки их шаблонизатору
    var API_KEY = '2656466-4e611d876bc99286937427964';
      var URL = "http://pixabay.com/api/?key="+API_KEY+"&response_group=image_details"+"&per_page=10"+"&q="+encodeURIComponent(q);
      var XHR = ("onload" in new XMLHttpRequest()) ? XMLHttpRequest : XDomainRequest;
      var xhr = new XHR();
      xhr.open('GET', URL, true);
      xhr.onload = function() {
            if (parseInt(JSON.parse(this.responseText).totalHits) > 0) {
                activityGridInit(JSON.parse(this.responseText)); // Парсим и отправляем шаблонизатору
              } else {
                console.log('No hits');
              }
      };
      xhr.onerror = function() {
      console.log('Ошибка ' + this.status);
    };
      xhr.send();
  };
  var activityGridInit = function (dataImg) { // Инициализация грида с картинками
    if (isActive === true) {
      $('.activity__grid').masonry('destroy');
    }
    var activityGridTmpl = $('#activity__grid__template').html();
    var activityGridHtml = tmpl(activityGridTmpl, {dataImg: dataImg});
    $('.activity__grid').html(activityGridHtml);
    $('.activity__grid').masonry({
    itemSelector: '.activity__grid__item',
    columnWidth: '.activity__grid__sizer'
    });
    isActive = true;
  };
  var searchBtn = $('.activity__box__search__form__submit');
  var searchInput = $('.activity__box__search__form__input');
  var reloadImg = function (e) { // Ловим поисковый запрос в поле ввода
    e.preventDefault();
    var query = searchInput.val();
    if (query.length === 0) {
      return;
    }
    getData(query);
  };
  searchBtn.click(reloadImg);
  $('.activity__grid').masonry({ // Первая инициализация Masonry
    itemSelector: '.activity__grid__item',
    columnWidth: '.activity__grid__sizer'
  });
  isActive = true;
  getData(''); // Первый запрос данных для блока картинок
});
